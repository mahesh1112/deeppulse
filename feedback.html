<!DOCTYPE html>
<html>
<head>
  <title>Feedback Form</title>
  <style>
    body {
      background: #f7f9fb;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;  /* Increased width to accommodate horizontal layout */
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 32px 24px;
    }
    h2 {
      text-align: center;
      color: #2d3748;
      margin-bottom: 24px;
    }
    form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 32px 40px;  /* Increased gap between elements */
      padding: 0 16px;
    }

    .question {
      margin-bottom: 16px;
      min-width: 0;
    }

    .input-text {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s ease;
      box-sizing: border-box;
      background-color: #f8fafc;
      max-height: 100px;  /* Set maximum height */
      overflow-y: auto;   /* Enable vertical scrolling */
      resize: vertical;   /* Allow vertical resizing */
      min-height: 45px;   /* Set minimum height */
    }

    /* Custom scrollbar styling */
    .input-text::-webkit-scrollbar {
      width: 8px;
    }

    .input-text::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }

    .input-text::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .input-text::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .question-label {
      font-weight: 500;
      color: #374151;
      margin-bottom: 12px;
      display: block;
      font-size: 0.95rem;
      letter-spacing: 0.01em;
    }

    /* Make specific question types full-width */
    .question.full-width,
    .question:has(.mcq-options),
    .question:has(.nps-container) {
      grid-column: 1 / -1;  /* Takes up all columns */
    }

    /* Add to your CSS */
    .question.half-width {
      grid-column: span 1;  /* Takes up one column */
    }

    .mcq-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .mcq-option {
      background: #f1f5f9;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mcq-option input[type="radio"] {
      accent-color: #6366f1;
    }
    .mcq-option:hover {
      background: #e0e7ef;
    }
    button[type="submit"] {
      background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 12px;
      grid-column: 1 / -1;  /* Make button full-width */
      width: 100%;
    }
    button[type="submit"]:hover {
      background: linear-gradient(90deg, #4f46e5 0%, #2563eb 100%);
    }
    .success-message {
      color: #22c55e;
      text-align: center;
      margin-top: 16px;
      font-weight: 500;
    }
    .error-message {
      color: #ef4444;
      text-align: center;
      margin-top: 16px;
      font-weight: 500;
    }
    
    /* Star Rating Styles */
    .star-rating {
      display: inline-flex;
      gap: 4px;
      direction: rtl;  /* Reverse the direction for hover effect */
    }
    .star {
      font-size: 24px;
      cursor: pointer;
      color: #cbd5e1;
      transition: color 0.2s;
    }
    .star.active {
      color: #fbbf24;
    }
    .star:hover,
    .star:hover ~ .star {
      color: #fbbf24;
    }
    
    /* NPS Slider Styles */
    .nps-container {
      padding: 16px 0;
    }
    .nps-slider {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      outline: none;
    }
    .nps-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      background: white;
      border: 2px solid #6366f1;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.1s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .nps-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }
    .nps-value {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      color: #6366f1;
      margin-top: 8px;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .loading-overlay.visible {
      opacity: 1;
      pointer-events: all;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Required Field Styling */
    .required-field::after {
      content: "*";
      color: #ef4444;
      margin-left: 4px;
    }
    .invalid-input {
      border-color: #ef4444 !important;
      animation: shake 0.4s linear;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
    
    /* Success Message Animation */
    .success-message {
      animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Responsive design */
    @media (max-width: 640px) {
      .container {
        max-width: 100%;
        margin: 0;
        border-radius: 0;
        padding: 24px 16px;
      }

      form {
        grid-template-columns: 1fr;  /* Single column on mobile */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Feedback Form</h2>
    <div id="formContainer">Loading...</div>
  </div>

  <div class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <script type="module">
    // Get the 'id' from the URL query parameters
    const formId = new URLSearchParams(window.location.search).get("id");

    const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");
    const supabase = createClient(
      "https://ortqxtfognuwkegcwini.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ydHF4dGZvZ251d2tlZ2N3aW5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjQ5MTYsImV4cCI6MjA2OTkwMDkxNn0.tJ8bnNnfXWxNslWuuD4nzcxWqJy6CW_h33-hXwPXGe8"
    );

    function createStarRating(name, required) {
      const container = document.createElement('div');
      container.className = 'star-rating';
      const stars = [];
      
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'star';
        star.innerHTML = 'â˜…';
        star.dataset.value = i;
        
        star.addEventListener('click', () => {
          stars.forEach((s, index) => {
            s.classList.toggle('active', index < i);
          });
          const input = container.querySelector('input');
          input.value = i;
        });
        
        stars.push(star);
        container.appendChild(star);
      }
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.required = required;
      container.appendChild(input);
      
      return container;
    }

    function createNPSSlider(name, required) {
      const container = document.createElement('div');
      container.className = 'nps-container';
      
      const slider = document.createElement('input');
      slider.type = 'range';
      slider.min = '0';
      slider.max = '10';
      slider.value = '5';
      slider.className = 'nps-slider';
      slider.name = name;
      slider.required = required;
      
      const value = document.createElement('div');
      value.className = 'nps-value';
      value.textContent = slider.value;
      
      slider.addEventListener('input', () => {
        value.textContent = slider.value;
      });
      
      container.appendChild(slider);
      container.appendChild(value);
      return container;
    }

    async function loadForm() {
      console.log('Fetching form with ID:', formId);
      const { data, error } = await supabase
        .from('forms')
        .select('html')
        .eq('id', formId)
        .single();

      console.log('Received data:', data);
      console.log('Error if any:', error);

      if (error || !data) {
        document.getElementById("formContainer").innerHTML = `
          <div class="error-message">
            Form not found. ID: ${formId}<br>
            ${error ? `Error: ${error.message}` : ''}
          </div>`;
        console.error('Error:', error);
        return;
      }

      try {
        console.log('Raw HTML content:', data.html);
        // Parse the JSON string from the html column
        const questions = JSON.parse(data.html);
        console.log('Parsed questions:', questions);
        
        if (!Array.isArray(questions)) {
          throw new Error('Questions data is not an array');
        }

        const form = document.createElement("form");
        form.id = "feedbackForm";

        // Update the form generation code to handle full-width questions
        questions.forEach((q, idx) => {
          const qDiv = document.createElement("div");
          qDiv.className = "question";
          
          // Layout logic based on question type and properties
          if (q.type === "text" && !q.multiline && !q.fullWidth) {
            qDiv.className += " half-width";  // Short text inputs side by side
          } else if (q.type === "rating") {
            qDiv.className += " half-width";  // Ratings side by side
          } else {
            qDiv.className += " full-width";  // Everything else full width
          }

          const label = document.createElement("label");
          label.className = "question-label";
          label.htmlFor = `q_${idx}`;
          label.innerText = q.label;
          qDiv.appendChild(label);

          if (q.type === "text") {
            const input = document.createElement(q.multiline ? "textarea" : "input");
            if (!q.multiline) {
              input.type = "text";
            }
            input.className = "input-text";
            input.id = `q_${idx}`;
            input.name = q.name;
            input.placeholder = q.placeholder || "";
            input.required = !!q.required;
            if (q.multiline) {
              input.rows = 4;  // Set initial number of rows for textarea
            }
            qDiv.appendChild(input);
          } else if (q.type === "mcq") {
            const optionsDiv = document.createElement("div");
            optionsDiv.className = "mcq-options";
            q.options.forEach((opt, optIdx) => {
              const optLabel = document.createElement("label");
              optLabel.className = "mcq-option";
              const radio = document.createElement("input");
              radio.type = "radio";
              radio.name = q.name;
              radio.value = opt;
              radio.required = !!q.required;
              optLabel.appendChild(radio);
              optLabel.appendChild(document.createTextNode(opt));
              optionsDiv.appendChild(optLabel);
            });
            qDiv.appendChild(optionsDiv);
          } else if (q.type === "rating") {
            qDiv.appendChild(createStarRating(q.name, q.required));
          } else if (q.type === "nps") {
            qDiv.appendChild(createNPSSlider(q.name, q.required));
          }
          form.appendChild(qDiv);
        });

        const submitBtn = document.createElement("button");
        submitBtn.type = "submit";
        submitBtn.innerText = "Submit";
        form.appendChild(submitBtn);

        document.getElementById("formContainer").innerHTML = "";
        document.getElementById("formContainer").appendChild(form);

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          
          // Show loading overlay
          document.querySelector('.loading-overlay').classList.add('visible');
          
          try {
            const formData = new FormData(form);
            const answers = {};
            formData.forEach((value, key) => answers[key] = value);

            const { error: insertError } = await supabase
              .from('responses')
              .insert([{ form_slug: formId, answers }]);

            if (insertError) {
              form.insertAdjacentHTML('beforeend', `<div class="error-message">Something went wrong. Try again.</div>`);
            } else {
              form.reset();
              
              // Success animation
              const successMsg = document.createElement('div');
              successMsg.className = 'success-message';
              successMsg.textContent = 'Thank you for your feedback!';
              form.appendChild(successMsg);
            }
          } finally {
            // Hide loading overlay
            document.querySelector('.loading-overlay').classList.remove('visible');
          }
        });
      } catch (parseError) {
        document.getElementById("formContainer").innerHTML = `<div class="error-message">Error parsing form data.</div>`;
        console.error('Parse error:', parseError);
      }
    }

    // Call the function to load the form
    loadForm().catch(err => {
      console.error('Fatal error:', err);
      document.getElementById("formContainer").innerHTML = `
        <div class="error-message">An unexpected error occurred.</div>`;
    });
  </script>
</body>
</html>
